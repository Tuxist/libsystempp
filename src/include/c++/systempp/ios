#include <iosfwd>

#include <internal/ios_base.h>
#include <internal/char_traits.h>

#pragma once

namespace std {
  template<class StateT> class fpos;
 
  class ios_base;
  template<class CharT, class Traits = char_traits<CharT>>
    class basic_ios;
 
  // manipulators
  ios_base& boolalpha  (ios_base& str);
  ios_base& noboolalpha(ios_base& str);
 
  ios_base& showbase   (ios_base& str);
  ios_base& noshowbase (ios_base& str);
 
  ios_base& showpoint  (ios_base& str);
  ios_base& noshowpoint(ios_base& str);
 
  ios_base& showpos    (ios_base& str);
  ios_base& noshowpos  (ios_base& str);
 
  ios_base& skipws     (ios_base& str);
  ios_base& noskipws   (ios_base& str);
 
  ios_base& uppercase  (ios_base& str);
  ios_base& nouppercase(ios_base& str);
 
  ios_base& unitbuf    (ios_base& str);
  ios_base& nounitbuf  (ios_base& str);
 
  // adjustfield
  ios_base& internal   (ios_base& str);
  ios_base& left       (ios_base& str);
  ios_base& right      (ios_base& str);
 
  // basefield
  ios_base& dec        (ios_base& str);
  ios_base& hex        (ios_base& str);
  ios_base& oct        (ios_base& str);
 
  // floatfield
  ios_base& fixed      (ios_base& str);
  ios_base& scientific (ios_base& str);
  ios_base& hexfloat   (ios_base& str);
  ios_base& defaultfloat(ios_base& str);
 
  // error reporting
  enum class io_errc {
    stream = 1
  };
 
  template<> struct is_error_code_enum<io_errc> : public true_type { };
  error_code make_error_code(io_errc e) noexcept;
  error_condition make_error_condition(io_errc e) noexcept;
  const error_category& iostream_category() noexcept;
}

namespace std {
  class ios_base {
  public:
    class failure;              // see description
 
    // fmtflags
    typedef unsigned int fmtflags;

    static constexpr fmtflags boolalpha   = 0x0001;
    static constexpr fmtflags dec         = 0x0002;
    static constexpr fmtflags fixed       = 0x0004;
    static constexpr fmtflags hex         = 0x0008;
    static constexpr fmtflags internal    = 0x0010;
    static constexpr fmtflags left        = 0x0020;
    static constexpr fmtflags oct         = 0x0040;
    static constexpr fmtflags right       = 0x0080;
    static constexpr fmtflags scientific  = 0x0100;
    static constexpr fmtflags showbase    = 0x0200;
    static constexpr fmtflags showpoint   = 0x0400;
    static constexpr fmtflags showpos     = 0x0800;
    static constexpr fmtflags skipws      = 0x1000;
    static constexpr fmtflags unitbuf     = 0x2000
    static constexpr fmtflags uppercase   = 0x4000;
    static constexpr fmtflags adjustfield = left | right | internal;
    static constexpr fmtflags basefield   = dec | oct | hex;
    static constexpr fmtflags floatfield  = scientific | fixed;
 
    // iostate
    typedef unsigned int iostate;
    static constexpr iostate badbit  = 0x1;
    static constexpr iostate eofbit  = 0x2;
    static constexpr iostate failbit = 0x4;
    static constexpr iostate goodbit = 0x0;
 
    // openmode
    typedef unsigned int openmode;
    static constexpr openmode app    = 0x01;
    static constexpr openmode ate    = 0x02;
    static constexpr openmode binary = 0x04;
    static constexpr openmode in     = 0x08;
    static constexpr openmode out    = 0x10;
    static constexpr openmode trunc  = 0x20;
 
    // seekdir
    enum seekdir {beg, cur, end};
 
    class Init;
 
    // fmtflags state
    fmtflags flags() const;
    fmtflags flags(fmtflags fmtfl);
    fmtflags setf(fmtflags fmtfl);
    fmtflags setf(fmtflags fmtfl, fmtflags mask);
    void unsetf(fmtflags mask);
 
    streamsize precision() const;
    streamsize precision(streamsize prec);
    streamsize width() const;
    streamsize width(streamsize wide);
 
    // locales
    locale imbue(const locale& loc);
    locale getloc() const;
 
    // storage
    static int xalloc();
    long&  iword(int idx);
    void*& pword(int idx);
 
    // destructor
    virtual ~ios_base();
 
    // callbacks
    enum event { erase_event, imbue_event, copyfmt_event };
    using event_callback = void (*)(event, ios_base&, int idx);
    void register_callback(event_callback fn, int idx);
 
    ios_base(const ios_base&) = delete;
    ios_base& operator=(const ios_base&) = delete;
 
    static bool sync_with_stdio(bool sync = true);
 
  protected:
    ios_base();
 
  private:
    static int index;           // exposition only
    long*  iarray;              // exposition only
    void** parray;              // exposition only
  };
}

namespace std {
  class ios_base::failure : public system_error {
  public:
    explicit failure(const string& msg, const error_code& ec = io_errc::stream);
    explicit failure(const char* msg, const error_code& ec = io_errc::stream);
  };
}

namespace std {
  class ios_base::Init {
  public:
    Init();
    Init(const Init&) = default;
    ~Init();
    Init& operator=(const Init&) = default;
  private:
    static int init_cnt;        // exposition only
  };
}

namespace std {
  template<class StateT> class fpos {
  public:
    // members
    StateT state() const;
    void state(stateT);
  private;
    StateT st;                  // exposition only
  };
}

namespace std {
  template<class CharT, class Traits = char_traits<CharT>>
  class basic_ios : public ios_base {
  public:
    using char_type   = CharT;
    using int_type    = typename Traits::int_type;
    using pos_type    = typename Traits::pos_type;
    using off_type    = typename Traits::off_type;
    using traits_type = Traits;
 
    // flags functions
    explicit operator bool() const;
    bool operator!() const;
    iostate rdstate() const;
    void clear(iostate state = goodbit);
    void setstate(iostate state);
    bool good() const;
    bool eof()  const;
    bool fail() const;
    bool bad()  const;
 
    iostate exceptions() const;
    void exceptions(iostate except);
 
    // constructor/destructor
    explicit basic_ios(basic_streambuf<CharT, Traits>* sb);
    virtual ~basic_ios();
 
    // members
    basic_ostream<CharT, Traits>* tie() const;
    basic_ostream<CharT, Traits>* tie(basic_ostream<CharT, Traits>* tiestr);
 
    basic_streambuf<CharT, Traits>* rdbuf() const;
    basic_streambuf<CharT, Traits>* rdbuf(basic_streambuf<CharT, Traits>* sb);
 
    basic_ios& copyfmt(const basic_ios& rhs);
 
    char_type fill() const;
    char_type fill(char_type ch);
 
    locale imbue(const locale& loc);
 
    char      narrow(char_type c, char dfault) const;
    char_type widen(char c) const;
 
    basic_ios(const basic_ios&) = delete;
    basic_ios& operator=(const basic_ios&) = delete;
 
  protected:
    basic_ios();
    void init(basic_streambuf<CharT, Traits>* sb);
    void move(basic_ios& rhs);
    void move(basic_ios&& rhs);
    void swap(basic_ios& rhs) noexcept;
    void set_rdbuf(basic_streambuf<CharT, Traits>* sb);
 
  };
}
